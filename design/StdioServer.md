<!--
Copyright (c) 2024 Martin Bechard <martin.bechard@DevConsult.ca>
This software is licensed under the MIT License.
File: /Users/martinbechard/dev/mcp-dev-prompter/design/StdioServer.md
This was generated by Claude Sonnet 3.5, with the assistance of my human mentor

Design document for the stdio-based server implementation
Stdio: The prompt's path to communication!
-->

# StdioServer Design

## Overview

The StdioServer implements the MCP Transport interface for communication over standard input/output. It handles JSON-RPC message parsing and transmission while providing debug logging capabilities.

## Design Requirements

1. Command Line Arguments

   - MUST accept --debug flag to enable debug mode
   - MUST accept --template-dir to specify template directory location
   - MUST provide default template directory ("./templates")
   - MUST validate arguments using Zod schema

2. Protocol Message Handling

   - MUST implement Transport interface from MCP SDK
   - MUST parse incoming JSON-RPC messages from stdin
   - MUST send JSON-RPC messages to stdout
   - MUST maintain message integrity
   - MUST handle parsing errors gracefully

3. Debug Logging

   - MUST initialize Logger with debug mode setting
   - MUST trace transport start/stop events in debug mode
   - MUST use Logger for all debug output
   - MUST NOT interfere with protocol message flow

4. Error Handling
   - MUST handle stdin errors through onerror callback
   - MUST handle JSON parsing errors gracefully
   - MUST maintain protocol message integrity during errors
   - MUST use Logger for error reporting

## Implementation Details

1. Command Line Processing

```typescript
const CommandLineArgs = z.object({
  debug: z.boolean().default(false),
  templateDir: z.string(),
});
```

2. Transport Interface Implementation

```typescript
export class StdioServer implements Transport {
  onclose?: () => void;
  onerror?: (error: Error) => void;
  onmessage?: (message: JSONRPCMessage) => void;

  async start(): Promise<void>;
  async send(message: JSONRPCMessage): Promise<void>;
  async close(): Promise<void>;
}
```

3. Message Flow

   - Incoming:

     1. Read UTF-8 encoded data from stdin
     2. Parse as JSON-RPC message
     3. Call onmessage callback with parsed message
     4. Handle any parsing errors through onerror

   - Outgoing:
     1. Receive JSONRPCMessage object
     2. Stringify to JSON
     3. Write to stdout with newline

4. Debug Mode
   - Initialize Logger with debug flag
   - Log transport start/stop events
   - Maintain separation between debug logs and protocol messages

## Error Handling

1. Input Parsing Errors

   - Catch JSON.parse errors
   - Report through onerror callback
   - Continue processing subsequent messages

2. Stdin Errors

   - Listen for stdin 'error' events
   - Report through onerror callback
   - Maintain transport state

3. Command Line Errors
   - Validate through Zod schema
   - Throw validation errors early
   - Provide clear error messages

## State Management

1. Transport State

   - Track running state with isRunning flag
   - Prevent multiple start/close calls
   - Ensure clean shutdown

2. Configuration State
   - Parse command line args once at construction
   - Store in immutable config object
   - Use throughout lifecycle

## Implementation Notes

1. Initialization

   - Parse command line args first
   - Initialize Logger with debug setting
   - Setup stdin handlers
   - Prepare for message processing

2. Message Processing

   - Use UTF-8 encoding for stdin
   - Handle messages line by line
   - Maintain protocol message integrity
   - Report errors without breaking flow

3. Shutdown

   - Close cleanly when requested
   - Notify through onclose callback
   - Log shutdown in debug mode
   - Prevent further operations

4. Debug Support
   - Use Logger for all debug output
   - Trace transport lifecycle events
   - Maintain separation from protocol messages
   - Enable/disable based on command line flag
